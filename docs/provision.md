# Provision ワークフロー完全解説

このドキュメントでは、F5（デバッグ実行）または Provision コマンド実行時に何が起こるかを詳細に説明します。

## 全体の流れ

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                         F5 (デバッグ実行) を押す                               │
└──────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│ m365agents.local.yml の provision セクションが順次実行される                   │
└──────────────────────────────────────────────────────────────────────────────┘
```

## ワークフロー定義ファイル

| 環境 | ファイル | 用途 |
|------|---------|------|
| local | `m365agents.local.yml` | F5 デバッグ実行時 |
| dev | `m365agents.yml` | Toolkit の Provision コマンド実行時 |

---

## Step 1: teamsApp/create

### 処理内容
Microsoft 365（Teams Developer Portal）に新しいアプリを登録する。

### 入力
| 入力元 | 値 |
|-------|-----|
| yml の `name` | `GitHubIssueSearch${{APP_NAME_SUFFIX}}` |
| `env/.env.local` の `APP_NAME_SUFFIX` | `-v1` |
| **最終的な名前** | `GitHubIssueSearch-v1` |

### 処理
1. Microsoft Graph API を呼び出し
2. Teams App を作成（または既存の TEAMS_APP_ID があればスキップ）
3. 新しい App ID を取得

### 出力
| 出力先 | 内容 |
|-------|------|
| `env/.env.local` | `TEAMS_APP_ID=xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx` |

### 条件分岐
- `TEAMS_APP_ID` が既に存在する場合 → 新規作成をスキップ（既存のアプリを使用）
- `TEAMS_APP_ID` が空の場合 → 新規作成して ID を書き込み

---

## Step 2: cli/runNpmCommand (npm install)

### 処理内容
Node.js の依存パッケージをインストールする。

### 入力
| 入力元 | 値 |
|-------|-----|
| コマンド | `npm install --no-audit --progress=false` |
| `package.json` | 依存パッケージ定義 |

### 出力
| 出力先 | 内容 |
|-------|------|
| `node_modules/` | 依存パッケージ群 |
| `package-lock.json` | ロックファイル更新 |

---

## Step 3: cli/runNpmCommand (generate:env)

### 処理内容
`env/.env.local` の値を TypeSpec で使える形式に変換する。

### 入力
| 入力元 | 値 |
|-------|-----|
| コマンド | `npm run generate:env -- local` |
| `env/.env.local` | 環境変数定義 |
| `scripts/generate-env.js` | 変換スクリプト |

### 出力
| 出力先 | 内容 |
|-------|------|
| `src/agent/env.tsp` | TypeSpec 用の環境変数定義 |

### 生成される env.tsp の例
```typespec
// Auto-generated by scripts/generate-env.js - DO NOT EDIT
namespace Environment {
  const APP_NAME_SUFFIX = "-v1";
  const GITHUB_API_URL = "https://api.github.com";
  const TEAMSFX_ENV = "local";
  const TEAMS_APP_ID = "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx";
}
```

---

## Step 4: typeSpec/compile ⭐ 最重要ステップ

### 処理内容
TypeSpec ファイルをコンパイルして、Copilot が理解できる JSON/YAML ファイルを生成する。

### 入力
| 入力元 | 内容 |
|-------|------|
| `src/agent/main.tsp` | エントリーポイント |
| `src/agent/actions/github.tsp` | API 定義（main.tsp から import） |
| `src/agent/prompts/instructions.tsp` | 指示定義（main.tsp から import） |
| `src/agent/env.tsp` | 環境変数（Step 3 で生成） |
| `appPackage/manifest.json` | ベーステンプレート |
| `tspconfig.yaml` | コンパイラ設定 |

### 処理
1. main.tsp を読み込み
2. import 文を辿って依存ファイルを再帰的に読み込み
3. `@agent`, `@instructions`, `@conversationStarter` などのデコレータを解析
4. API 定義から OpenAPI 仕様を生成
5. Declarative Agent マニフェストを生成
6. ベース manifest.json に copilotAgents セクションを追加

### 出力
| 出力先 | 生成元 | 内容 |
|-------|-------|------|
| `.generated/manifest.json` | `appPackage/manifest.json` + TypeSpec | copilotAgents セクション追加 |
| `.generated/declarativeAgent.json` | `@agent`, `@instructions`, `@conversationStarter` | エージェント定義 |
| `.generated/githubapi-apiplugin.json` | `@actions` メタデータ + API 定義 | API Plugin 定義 |
| `.generated/githubapi-openapi.yml` | API 操作定義 | OpenAPI 3.0 仕様 |
| `.generated/specs/openapi.json` | 同上 | OpenAPI（JSON 形式） |

### 入出力の対応関係

```
┌─────────────────────────────────────────────────────────────────────┐
│ main.tsp                                                             │
│                                                                      │
│ @agent("GitHubIssueSearch", "説明...")  ──────────────────────────┐  │
│ @instructions(Prompts.INSTRUCTIONS)     ──────────────────────────┼──┼─→ declarativeAgent.json
│ @conversationStarter(#{...})            ──────────────────────────┘  │      ├─ name
│                                                                      │      ├─ description
│ namespace GitHubIssueSearch {                                        │      ├─ instructions
│   op searchIssues is GitHubAPI.searchIssues;  ───────────────────────┼─→    └─ conversation_starters
│ }                                                                    │
└─────────────────────────────────────────────────────────────────────┘
                                                                       
┌─────────────────────────────────────────────────────────────────────┐
│ actions/github.tsp                                                   │
│                                                                      │
│ @service(...)                                                        │
│ @server(Environment.GITHUB_API_URL)     ─────────────────────────────┼─→ githubapi-openapi.yml
│ @actions({...})                         ─────────────────────────────┼─→ githubapi-apiplugin.json
│                                                                      │      ├─ name_for_human
│ namespace GitHubAPI {                                                │      ├─ description_for_model
│   @route("/search/issues")                                           │      └─ functions[]
│   @get op searchIssues(...): IssueSearchResult;                      │
│ }                                                                    │
└─────────────────────────────────────────────────────────────────────┘
                                                                       
┌─────────────────────────────────────────────────────────────────────┐
│ appPackage/manifest.json (ベーステンプレート)                         │
│                                                                      │
│ {                                                                    │
│   "name": { "short": "GitHubIssueSearch${{APP_NAME_SUFFIX}}" },      │
│   "description": {...},                                              │
│   ...                                 ───────────────────────────────┼─→ .generated/manifest.json
│   // copilotAgents セクションは無い                                   │      ├─ 元の内容すべて
│ }                                                                    │      └─ + copilotAgents: {...}
└─────────────────────────────────────────────────────────────────────┘
```

---

## Step 5: teamsApp/zipAppPackage

### 処理内容
アプリパッケージ（ZIP）を作成する。

### 入力
| 入力元 | 内容 |
|-------|------|
| `appPackage/manifest.json` | ベーステンプレート（プレースホルダー含む） |
| `appPackage/.generated/*` | TypeSpec コンパイル出力 |
| `appPackage/color.png` | カラーアイコン |
| `appPackage/outline.png` | アウトラインアイコン |
| `appPackage/adaptiveCards/*` | Adaptive Card テンプレート |
| `env/.env.local` | 環境変数（プレースホルダー置換用） |

### 処理
1. manifest.json を読み込み
2. `${{TEAMS_APP_ID}}` → 実際の ID に置換
3. `${{APP_NAME_SUFFIX}}` → `-v1` に置換
4. `.generated/` 配下のファイルを含める
5. アイコン、Adaptive Card を含める
6. ZIP ファイルを作成

### 出力
| 出力先 | 内容 |
|-------|------|
| `appPackage/build/appPackage.local.zip` | デプロイ可能なアプリパッケージ |

### ZIP の中身
```
appPackage.local.zip
├── manifest.json           ← プレースホルダー置換済み
├── declarativeAgent.json
├── githubapi-apiplugin.json
├── githubapi-openapi.yml
├── color.png
├── outline.png
└── adaptiveCards/
    └── searchIssues.json
```

---

## Step 6: teamsApp/validateAppPackage

### 処理内容
作成した ZIP パッケージが Microsoft 365 の要件を満たしているか検証する。

### 入力
| 入力元 | 内容 |
|-------|------|
| `appPackage/build/appPackage.local.zip` | 検証対象 |

### 処理
1. manifest.json のスキーマ検証
2. 必須フィールドの存在確認
3. アイコンサイズの確認
4. declarativeAgent.json の形式確認
5. OpenAPI 仕様の検証

### 出力
- 成功: 次のステップへ進む
- 失敗: エラーメッセージを表示して停止

---

## Step 7: teamsApp/update

### 処理内容
Teams Developer Portal のアプリを更新する。

### 入力
| 入力元 | 内容 |
|-------|------|
| `appPackage/build/appPackage.local.zip` | 更新内容 |
| `env/.env.local` の `TEAMS_APP_ID` | 更新対象のアプリ ID |

### 処理
1. Microsoft Graph API を呼び出し
2. 既存の Teams App (TEAMS_APP_ID) を特定
3. ZIP の内容でアプリ定義を更新

### 出力
- Teams Developer Portal のアプリが更新される（ファイル出力なし）

---

## Step 8: teamsApp/extendToM365

### 処理内容
Teams アプリを Microsoft 365 全体（Copilot Chat, Outlook, Office 等）に拡張する。

### 入力
| 入力元 | 内容 |
|-------|------|
| `appPackage/build/appPackage.local.zip` | 拡張するアプリ |
| `env/.env.local` の `TEAMS_APP_ID` | 対象アプリ |

### 処理
1. Microsoft 365 App Catalog API を呼び出し
2. アプリを M365 全体で利用可能にする
3. M365 固有の ID を取得

### 出力
| 出力先 | 内容 |
|-------|------|
| `env/.env.local` | `M365_TITLE_ID=T_xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx` |
| `env/.env.local` | `M365_APP_ID=xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx` |

> ⚠️ **重要**: Declarative Agent を Copilot Chat で使用するには、この extendToM365 ステップが必須です。
> このステップをスキップすると、Teams アプリとしてのみ登録され、Copilot Chat には表示されません。

---

## 全体のデータフロー図

```
env/.env.local                    src/agent/*.tsp                appPackage/
┌──────────────┐                 ┌──────────────┐               ┌──────────────┐
│APP_NAME_SUFFIX│                │  main.tsp    │               │manifest.json │
│GITHUB_API_URL │                │  ├─actions/  │               │ (template)   │
│(TEAMS_APP_ID) │────Step3────→  │  ├─prompts/  │               │              │
└──────────────┘                 │  └─env.tsp←──│               └──────────────┘
       │                         └──────────────┘                      │
       │                                │                              │
       │                         Step4  │ typeSpec/compile             │
       │                                ▼                              │
       │                         ┌──────────────┐                      │
       │                         │.generated/   │◀─────────────────────┘
       │                         │├manifest.json│ (copilotAgents追加)
       │                         │├declarative  │
       │                         ││ Agent.json  │
       │                         │├apiplugin.json│
       │                         │└openapi.yml  │
       │                         └──────────────┘
       │                                │
       │                         Step5  │ zipAppPackage
       │                                ▼
       └────────────────────────→┌──────────────┐
         (${{...}}を置換)        │build/        │
                                 │appPackage    │
                                 │ .local.zip   │
                                 └──────────────┘
                                        │
                          Step7,8       │ update & extendToM365
                                        ▼
                                 ┌──────────────┐
                                 │Microsoft 365 │
                                 │ Developer    │
                                 │ Portal       │
                                 └──────────────┘
                                        │
                                        ▼
                                 ┌──────────────┐
                                 │env/.env.local│
                                 │ M365_TITLE_ID│
                                 │ M365_APP_ID  │
                                 └──────────────┘
```

---

## まとめ表

| Step | アクション | 主な入力 | 主な出力 |
|------|-----------|---------|---------|
| 1 | teamsApp/create | yml の name, env | env に TEAMS_APP_ID |
| 2 | npm install | package.json | node_modules/ |
| 3 | generate:env | env/.env.local | src/agent/env.tsp |
| 4 | typeSpec/compile | *.tsp, manifest.json | .generated/* (5ファイル) |
| 5 | zipAppPackage | .generated/*, icons | appPackage.local.zip |
| 6 | validateAppPackage | ZIP | 検証結果（成功/失敗） |
| 7 | teamsApp/update | ZIP, TEAMS_APP_ID | Developer Portal 更新 |
| 8 | extendToM365 | ZIP | env に M365_*_ID |
